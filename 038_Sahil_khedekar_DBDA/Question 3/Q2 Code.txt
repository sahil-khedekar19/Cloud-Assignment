import os
import json
import logging
import urllib.parse
import boto3

logger = logging.getLogger()
logger.setLevel(logging.INFO)

sns = boto3.client("sns")
TOPIC_ARN = os.environ.get("TOPIC_ARN", "")

def lambda_handler(event, context):
    """
    Triggered by S3:ObjectCreated on prefix reports/daily/.
    Publishes basic metadata to SNS (no S3 head call needed).
    """
    logger.info("Received event: %s", json.dumps(event))

    if not TOPIC_ARN:
        raise RuntimeError("Environment variable TOPIC_ARN not set")

    for record in event.get("Records", []):
        bucket = record["s3"]["bucket"]["name"]
        key = urllib.parse.unquote_plus(record["s3"]["object"]["key"])
        size = record["s3"]["object"].get("size", "unknown")
        event_time = record.get("eventTime", "unknown")

        message = {
            "Bucket": bucket,
            "Key": key,
            "FileName": key.split("/")[-1],
            "Size (bytes)": size,
            "EventTime": event_time
        }

        sns.publish(
            TopicArn=TOPIC_ARN,
            Subject="New Daily Sales Report Uploaded",
            Message=json.dumps(message, indent=2)
        )
        logger.info(f"âœ… Published alert for file: {key}")

    return {"status": "success"}
